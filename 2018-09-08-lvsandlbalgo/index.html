<!DOCTYPE html>




<html class="theme-next mist" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="https://secure.gravatar.com/avatar/b3c7fcdb5ce311f9dccfab0032775efb?s=80?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="https://secure.gravatar.com/avatar/b3c7fcdb5ce311f9dccfab0032775efb?s=80?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="https://secure.gravatar.com/avatar/b3c7fcdb5ce311f9dccfab0032775efb?s=80?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="linux,LVS,load balance," />










<meta name="description" content="LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。">
<meta name="keywords" content="linux,LVS,load balance">
<meta property="og:type" content="article">
<meta property="og:title" content="LVS及负载均衡">
<meta property="og:url" content="http://lansheng.me/2018-09-08-lvsandlbalgo/index.html">
<meta property="og:site_name" content="Lankstra&#39;s blog">
<meta property="og:description" content="LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://lansheng.me/images/lvs-dr.png">
<meta property="og:image" content="http://lansheng.me/images/lvs-tun.png">
<meta property="og:image" content="http://lansheng.me/images/lvs-nat.png">
<meta property="og:image" content="http://lansheng.me/images/DR.png">
<meta property="og:image" content="http://lansheng.me/images/NAT.png">
<meta property="og:image" content="http://lansheng.me/images/FNAT.png">
<meta property="og:image" content="http://lansheng.me/images/netfilter.png">
<meta property="og:image" content="http://lansheng.me/images/conn_tab.png">
<meta property="og:updated_time" content="2020-06-06T07:47:59.318Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LVS及负载均衡">
<meta name="twitter:description" content="LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。">
<meta name="twitter:image" content="http://lansheng.me/images/lvs-dr.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"remove","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","oll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lansheng.me/2018-09-08-lvsandlbalgo/"/>





  <title>LVS及负载均衡 | Lankstra's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
          
        <span class="site-title">Lankstra's blog</span>
         
      </a>
    </div>
      
        <p class="site-subtitle">lankstra</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-github">
          <a href="http://www.github.com/lankstra" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-github"></i> <br />
            
            github
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lansheng.me/2018-09-08-lvsandlbalgo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lankstra">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lankstra's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LVS及负载均衡</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-08T00:00:00+08:00">
                2018-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/learn/" itemprop="url" rel="index">
                    <span itemprop="name">learn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018-09-08-lvsandlbalgo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018-09-08-lvsandlbalgo/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。<br><a id="more"></a></p>
<h3 id="负载均衡集群"><a href="#负载均衡集群" class="headerlink" title="负载均衡集群"></a>负载均衡集群</h3><p>使用集群技术和Linux操作系统实现一个高性能、高可用的服务器。<br>负载均衡集群指使用多台提供相同服务的服务器组成集群系统，提高服务的并发处理能力。负载均衡集群的前端使用一个调度器，将客户端请求平均分配到后端的服务器中，同时调度器可能还具有后端服务器状态检测的功能，将故障的服务器自动下线，使得集群具有一定的容错能力。</p>
<p>根据工作在的协议层划分可划分为：</p>
<ul>
<li>四层负载均衡：根据请求报文中的目标地址和端口进行调度</li>
<li>七层负载均衡：根据请求报文的内容进行调度，这种调度属于「代理」的方式</li>
</ul>
<p>根据软硬件划分：</p>
<ul>
<li>硬件负载均衡：<br>  F5 的 BIG-IP<br>  Citrix 的 NetScaler<br>这类硬件负载均衡器通常能同时提供四层和七层负载均衡，但同时也价格不菲</li>
<li>软件负载均衡：<br>  TCP 层：LVS，HaProxy，Nginx<br>  基于 HTTP 协议：Haproxy，Nginx，ATS（Apache Traffic Server），squid，varnish<br>  基于 MySQL 协议：mysql-proxy</li>
</ul>
<h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><p>LVS 是一个工作在四层的负载均衡器，它的实现和 iptables/netfilter 类似，工作在内核空间的 TCP/IP 协议栈上，LVS 工作在 INPUT Hook Funtion 上，并在 INPUT 设置附加规则，一旦客户端请求的是集群服务，LVS 会强行修改请求报文，将报文发往 POSTROUTING，转发至后端的主机。</p>
<h3 id="LVS的工作模型"><a href="#LVS的工作模型" class="headerlink" title="LVS的工作模型"></a>LVS的工作模型</h3><h4 id="VS-DR"><a href="#VS-DR" class="headerlink" title="VS/DR"></a>VS/DR</h4><p>和通过直接路由实现虚拟服务器的方法VS/DR（Virtual Server via Direct Routing）。LVS收到客户端的报文，修改目的MAC地址到RealServer。RealServer处理报文后以VIP为源IP地址返回数据给客户端。<br><img src="/images/lvs-dr.png" alt="lvs/dr"></p>
<h4 id="VS-TUN"><a href="#VS-TUN" class="headerlink" title="VS/TUN"></a>VS/TUN</h4><p>通过IP隧道实现虚拟服务器的方法VS/TUN （Virtual Server via IP Tunneling）。<br><img src="/images/lvs-tun.png" alt="lvs/tun"></p>
<h4 id="VS-NAT"><a href="#VS-NAT" class="headerlink" title="VS/NAT"></a>VS/NAT</h4><p>在IP负载均衡技术中，主要有通过网络地址转换（Network Address Translation）将一组服务器构成一个高性能的、高可用的虚拟服务器，称之为VS/NAT技术（Virtual Server via Network Address Translation）。VS/NAT模式进行两次NAT转换，在LVS收到客户端报文后，修改报文的目的IP地址(DNAT)，发往后端服务器RealServer。RealServer处理报文，返回数据给LVS，LVS修改报文的源地址(SNAT)，发往客户端。<br><img src="/images/lvs-nat.png" alt="lvs/nat"></p>
<h4 id="VS-FULLNAT"><a href="#VS-FULLNAT" class="headerlink" title="VS/FULLNAT"></a>VS/FULLNAT</h4><p>FULLNAT 由淘宝研发，目前还没有加入至 CentOS 可用的内核中，使用时需要向内核打补丁。<br>类似于 DNAT，它修改请求报文的源地址为 DIP，目标地址为 RIP 来实现转发。对于响应报文，源地址修改为 VIP，目标地址修改为 CIP 来实现转发。</p>
<p>特点：</p>
<ul>
<li>RIP，DIP 可以使用私有地址</li>
<li>RIP 和 DIP 可以不再同一网络中，且 RIP 的网关不需要指向 DIP</li>
<li>支持端口映射</li>
<li>请求和响应报文都经由 Director</li>
</ul>
<h3 id="LVS的调度算法"><a href="#LVS的调度算法" class="headerlink" title="LVS的调度算法"></a>LVS的调度算法</h3><p>当 LVS 接受到一个客户端对集群服务的请求后，它需要进行决策将请求调度至某一台后端主机进行响应。</p>
<h3 id="静态调度算法"><a href="#静态调度算法" class="headerlink" title="静态调度算法"></a>静态调度算法</h3><p>静态调度算法调度时不会考虑后端服务器的状态</p>
<h4 id="轮叫（Round-Robin）RR"><a href="#轮叫（Round-Robin）RR" class="headerlink" title="轮叫（Round Robin）RR"></a>轮叫（Round Robin）RR</h4><p>   调度器通过”轮叫”调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。</p>
<h4 id="加权轮叫（Weighted-Round-Robin）-WRR"><a href="#加权轮叫（Weighted-Round-Robin）-WRR" class="headerlink" title="加权轮叫（Weighted Round Robin） WRR"></a>加权轮叫（Weighted Round Robin） WRR</h4><p>   调度器通过”加权轮叫”调度算法根据真实服务器的不同处理能力来调度访问请求。 这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p>
<h4 id="目标地址散列调度（Destination-Hashing）DH"><a href="#目标地址散列调度（Destination-Hashing）DH" class="headerlink" title="目标地址散列调度（Destination Hashing）DH"></a>目标地址散列调度（Destination Hashing）DH</h4><p>   算法也是针对目标IP地址的负载均衡，但它是一种静态映射算法，通过一个散列（Hash）函数将一个目标IP地址映射到一台服务器。目标地址散列调度算法先根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p>
<h4 id="源地址散列调度（Source-Hashing）SH"><a href="#源地址散列调度（Source-Hashing）SH" class="headerlink" title="源地址散列调度（Source Hashing）SH"></a>源地址散列调度（Source Hashing）SH</h4><p> 算法正好与目标地址散列调度算法相反，它根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。它采用的散列函数与目标地址散列调度算法的相同。除了将请求的目标IP地址换成请求的源IP地址外，它的算法流程与目标地址散列调度算法的基本相似。在实际应用中，源地址散列调度和目标地址散列调度可以结合使用在防火墙集群中，它们可以保证整个系统的唯一出入口。</p>
<h3 id="动态调度算法"><a href="#动态调度算法" class="headerlink" title="动态调度算法"></a>动态调度算法</h3><p>动态调度算法在调度时，会根据后端 Realserver 的负载状态来决定调度选择，Realserver 的负载状态通常由活动链接（active），非活动链接（inactive）和权重来计算。</p>
<h4 id="最少链接（Least-Connections）LC"><a href="#最少链接（Least-Connections）LC" class="headerlink" title="最少链接（Least Connections）LC"></a>最少链接（Least Connections）LC</h4><p>  调度器通过”最少连接”调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。 如果集群系统的真实服务器具有相近的系统性能，采用”最小连接”调度算法可以较好地均衡负载。</p>
<h4 id="加权最少链接（Weighted-Least-Connections）WLC"><a href="#加权最少链接（Weighted-Least-Connections）WLC" class="headerlink" title="加权最少链接（Weighted Least Connections）WLC"></a>加权最少链接（Weighted Least Connections）WLC</h4><p>  在集群系统中的服务器性能差异较大的情况下，调度器采用”加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p>
<h4 id="基于局部性的最少链接（Locality-Based-Least-Connections）LBLC"><a href="#基于局部性的最少链接（Locality-Based-Least-Connections）LBLC" class="headerlink" title="基于局部性的最少链接（Locality-Based Least Connections）LBLC"></a>基于局部性的最少链接（Locality-Based Least Connections）LBLC</h4><p>  “基于局部性的最少链接” 调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器 是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用”最少链接”的原则选出一个可用的服务 器，将请求发送到该服务器。</p>
<h4 id="带复制的基于局部性最少链接（Locality-Based-Least-Connections-with-Replication）LBLCR"><a href="#带复制的基于局部性最少链接（Locality-Based-Least-Connections-with-Replication）LBLCR" class="headerlink" title="带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）LBLCR"></a>带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）LBLCR</h4><p>  “带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。它与LBLC算法的不同之处是它要维护从一个 目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务 器组，按”最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按”最小连接”原则从这个集群中选出一 台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改， 将最忙的服务器从服务器组中删除，以降低复制的 程度。</p>
<h3 id="lvs代码解析"><a href="#lvs代码解析" class="headerlink" title="lvs代码解析"></a>lvs代码解析</h3><h4 id="LVS-DR"><a href="#LVS-DR" class="headerlink" title="LVS/DR"></a>LVS/DR</h4><p><img src="/images/DR.png" alt="DR"></p>
<p>DR模式，LVS将客户端的报文修改源MAC地址后转发给真实服务器。真实服务器处理报文后以VIP为源地址通过单独的路由返回给客户端。</p>
<h4 id="LVS-NAT"><a href="#LVS-NAT" class="headerlink" title="LVS/NAT"></a>LVS/NAT</h4><p><img src="/images/NAT.png" alt="NAT"></p>
<p>NAT模式，LVS收到客户端报文，修改目的地址后发往真实服务器，真实服务器处理报文后将报文返回网关，即LVS设备。LVS将响应报文源地址修改后返回给客户端。</p>
<h4 id="LVS-FNAT"><a href="#LVS-FNAT" class="headerlink" title="LVS/FNAT"></a>LVS/FNAT</h4><p><img src="/images/FNAT.png" alt="FNAT"></p>
<p>FNAT模式，LVS收到客户端报文，修改目的地址与源地址后发往真实服务器，真实服务器处理报文后将报文返回LVS的localIP，LVS将响应报文源地址和目的地址修改后返回给客户端。相比于NAT模式，LVS与后端服务器可以跨不同vlan；相比于DR模式，后端服务器位于内网环境，不暴露。</p>
<h4 id="LVS与netfilter"><a href="#LVS与netfilter" class="headerlink" title="LVS与netfilter"></a>LVS与netfilter</h4><p><img src="/images/netfilter.png" alt="netfilter"></p>
<p>LVS向netfilter框架注册hook函数：<code>ip_vs_in</code>与<code>ip_vs_out</code>。</p>
<p>从网卡收到的报文上送协议栈后，经过netfilter的PRE_ROUTING hook点进入LVS框架。</p>
<h4 id="LVS连接"><a href="#LVS连接" class="headerlink" title="LVS连接"></a>LVS连接</h4><p>连接由源地址，源端口，目的地址，目的端口组成：<code>&lt;s_addr, s_port, d_addr, d_port&gt;</code></p>
<p><code>ipvs</code>连接用<code>ip_vs_conn</code>结构体描述，<code>ipvs</code>连接索引用<code>ip_vs_conn_idx</code>结构体描述。</p>
<p>每个ipvs连接对应两个方向的连接索引：</p>
<p>连接入方向索引<code>in_idx</code>：<code>client -&gt; lvs</code></p>
<p>连接出方向索引<code>out_idx</code>：<code>rs -&gt; lvs</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -+--&gt; in_idx</span><br><span class="line">    |</span><br><span class="line">    +--&gt; out_idx</span><br></pre></td></tr></table></figure>
<h5 id="连接、连接索引、连接表之间的关系"><a href="#连接、连接索引、连接表之间的关系" class="headerlink" title="连接、连接索引、连接表之间的关系"></a>连接、连接索引、连接表之间的关系</h5><p><img src="/images/conn_tab.png" alt="conn_tab"></p>
<h4 id="重要的数据结构"><a href="#重要的数据结构" class="headerlink" title="重要的数据结构"></a>重要的数据结构</h4><h5 id="连接ip-vs-conn"><a href="#连接ip-vs-conn" class="headerlink" title="连接ip_vs_conn:"></a>连接<code>ip_vs_conn</code>:</h5><p>连接结构体用于描述客户端向服务器发起的连接。对于LVS，连接有两个，客户端与LVS的连接、LVS与后端真实服务器的连接。为了区分，用连接索引描述LVS两个方向的连接。</p>
<p>连接结构体的成员主要有两个方向的索引，协议族、协议类型，客户端地址端口，虚拟服务地址端口，LVS本地地址端口，后端地址端口等。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_conn</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_conn_idx</span> *<span class="title">in_idx</span>;</span>	<span class="comment">/* client-vs hash index */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_conn_idx</span> *<span class="title">out_idx</span>;</span>	<span class="comment">/* rs-vs hash index */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Protocol, addresses and port numbers */</span></span><br><span class="line">	u16 af;			<span class="comment">/* address family */</span></span><br><span class="line">	__u16 protocol;		<span class="comment">/* Which protocol (TCP/UDP) */</span></span><br><span class="line">	<span class="keyword">union</span> nf_inet_addr caddr;	<span class="comment">/* client address */</span></span><br><span class="line">	<span class="keyword">union</span> nf_inet_addr vaddr;	<span class="comment">/* virtual address */</span></span><br><span class="line">	<span class="keyword">union</span> nf_inet_addr laddr;	<span class="comment">/* local address */</span></span><br><span class="line">	<span class="keyword">union</span> nf_inet_addr daddr;	<span class="comment">/* destination address */</span></span><br><span class="line">	__be16 cport;</span><br><span class="line">	__be16 vport;</span><br><span class="line">	__be16 lport;</span><br><span class="line">	__be16 dport;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_dest</span> *<span class="title">dest</span>;</span>	<span class="comment">/* real server */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_laddr</span> *<span class="title">local</span>;</span>	<span class="comment">/* local address */</span></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="连接索引ip-vs-conn-idx"><a href="#连接索引ip-vs-conn-idx" class="headerlink" title="连接索引ip_vs_conn_idx:"></a>连接索引<code>ip_vs_conn_idx</code>:</h5><p>连接索引用于描述LVS与客户端、LVS与后端的连接。对于入方向<code>in_idx</code>，源地址、源端口为客户端的地址、端口，目的地址、目的端口为虚拟服务的地址、端口；出方向<code>out_idx</code>，源地址、源端口为后端服务器的地址、端口，目的地址、目的端口为LVS的本地地址、端口。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_conn_idx</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">c_list</span>;</span>   <span class="comment">/* hashed list heads */</span></span><br><span class="line"></span><br><span class="line">   u16 af;          <span class="comment">/* address family */</span></span><br><span class="line">   __u16 protocol;       <span class="comment">/* Which protocol (TCP/UDP) */</span></span><br><span class="line">   <span class="keyword">union</span> nf_inet_addr s_addr; <span class="comment">/* source address */</span></span><br><span class="line">   <span class="keyword">union</span> nf_inet_addr d_addr; <span class="comment">/* destination address */</span></span><br><span class="line">   __be16 s_port;    <span class="comment">/* source port */</span></span><br><span class="line">   __be16 d_port;    <span class="comment">/* destination port */</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_conn</span> *<span class="title">cp</span>;</span> <span class="comment">/* point to connection */</span></span><br><span class="line">   <span class="keyword">volatile</span> __u16 flags;  <span class="comment">/* status flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="虚拟服务ip-vs-service"><a href="#虚拟服务ip-vs-service" class="headerlink" title="虚拟服务ip_vs_service:"></a>虚拟服务<code>ip_vs_service</code>:</h5><p>虚拟服务用结构体<code>ip_vs_service</code>描述，虚拟服务在客户端角度看是一个虚拟服务的地址和端口号。虚拟服务下的多个真实服务器通过结构体中的<code>destinations</code>链表连接，在客户端向虚拟服务发起请求时，LVS根据调度算法从该虚拟服务下的后端服务器中选择，发往后端。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_service</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">s_list</span>;</span>	<span class="comment">/* for normal service table */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">f_list</span>;</span>	<span class="comment">/* for fwmark-based service table */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> refcnt;	<span class="comment">/* reference counter */</span></span><br><span class="line"></span><br><span class="line">	u16 af;			<span class="comment">/* address family */</span></span><br><span class="line">	__u16 protocol;		<span class="comment">/* which protocol (TCP/UDP) */</span></span><br><span class="line">	<span class="keyword">union</span> nf_inet_addr addr;	<span class="comment">/* IP address for virtual service */</span></span><br><span class="line">	__be16 port;		<span class="comment">/* port number for the service */</span></span><br><span class="line">	__u32 fwmark;		<span class="comment">/* firewall mark of the service */</span></span><br><span class="line">	<span class="keyword">unsigned</span> flags;		<span class="comment">/* service status flags */</span></span><br><span class="line">	<span class="keyword">unsigned</span> timeout;	<span class="comment">/* persistent timeout in ticks */</span></span><br><span class="line">	__be32 netmask;		<span class="comment">/* grouping granularity */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* for realservers list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">destinations</span>;</span>	<span class="comment">/* real server d-linked list */</span></span><br><span class="line">	__u32 num_dests;	<span class="comment">/* number of servers */</span></span><br><span class="line">	<span class="keyword">long</span> weight;           <span class="comment">/* sum of servers weight */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* for local ip address list, now only used in FULL NAT model */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">laddr_list</span>;</span>	<span class="comment">/* local ip address list */</span></span><br><span class="line">	<span class="keyword">rwlock_t</span> laddr_lock;	<span class="comment">/* lock for protect curr_laddr */</span></span><br><span class="line">	__u32 num_laddrs;	<span class="comment">/* number of local ip address */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">curr_laddr</span>;</span>	<span class="comment">/* laddr data list head */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_stats</span> <span class="title">stats</span>;</span>	<span class="comment">/* statistics for the service */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_app</span> *<span class="title">inc</span>;</span>	<span class="comment">/* bind conns to this app inc */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* for scheduling */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_scheduler</span> *<span class="title">scheduler</span>;</span>	<span class="comment">/* bound scheduler object */</span></span><br><span class="line">	<span class="keyword">rwlock_t</span> sched_lock;	<span class="comment">/* lock sched_data */</span></span><br><span class="line">	<span class="keyword">void</span> *sched_data;	<span class="comment">/* scheduler application data */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* for VS private establish state timeout, it should be inherited by every connection data structure */</span></span><br><span class="line">	<span class="keyword">unsigned</span> est_timeout;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_service</span> *<span class="title">svc0</span>;</span>	<span class="comment">/* the svc of cpu0 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="真实服务器ip-vs-dest"><a href="#真实服务器ip-vs-dest" class="headerlink" title="真实服务器ip_vs_dest:"></a>真实服务器<code>ip_vs_dest</code>:</h5><p>真实服务器也叫后端服务器，用结构体<code>ip_vs_dest</code>描述，结构体成员主要由该后端地址、端口，权重，标志位，连接统计等信息组成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_dest</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">n_list</span>;</span>   <span class="comment">/* for the dests in the service */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_list</span>;</span>   <span class="comment">/* for table with all the dests */</span></span><br><span class="line"></span><br><span class="line">   u16 af;          <span class="comment">/* address family */</span></span><br><span class="line">   <span class="keyword">union</span> nf_inet_addr addr;   <span class="comment">/* IP address of the server */</span></span><br><span class="line">   __be16 port;      <span class="comment">/* port number of the server */</span></span><br><span class="line">   <span class="keyword">volatile</span> <span class="keyword">unsigned</span> flags;   <span class="comment">/* dest status flags */</span></span><br><span class="line">   <span class="keyword">atomic_t</span> conn_flags;   <span class="comment">/* flags to copy to conn */</span></span><br><span class="line">   <span class="keyword">atomic_t</span> weight;   <span class="comment">/* server weight */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">atomic_t</span> refcnt;   <span class="comment">/* reference counter */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_stats</span> <span class="title">stats</span>;</span>  <span class="comment">/* statistics for destination server */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* connection counters and thresholds */</span></span><br><span class="line">   <span class="keyword">atomic_t</span> activeconns;  <span class="comment">/* active connections */</span></span><br><span class="line">   <span class="keyword">atomic_t</span> inactconns;   <span class="comment">/* inactive connections */</span></span><br><span class="line">   <span class="keyword">atomic_t</span> persistconns; <span class="comment">/* persistent connections */</span></span><br><span class="line">   __u32 u_threshold; <span class="comment">/* upper threshold */</span></span><br><span class="line">   __u32 l_threshold; <span class="comment">/* lower threshold */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* for destination cache */</span></span><br><span class="line">   <span class="keyword">spinlock_t</span> dst_lock;   <span class="comment">/* lock of dst_cache */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> *<span class="title">dst_cache</span>;</span>   <span class="comment">/* destination cache entry */</span></span><br><span class="line">   u32 dst_rtos;     <span class="comment">/* RT_TOS(tos) for dst */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* for virtual service */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_service</span> *<span class="title">svc</span>;</span> <span class="comment">/* service it belongs to */</span></span><br><span class="line">   __u16 protocol;       <span class="comment">/* which protocol (TCP/UDP) */</span></span><br><span class="line">   <span class="keyword">union</span> nf_inet_addr vaddr;  <span class="comment">/* virtual IP address */</span></span><br><span class="line">   __be16 vport;     <span class="comment">/* virtual port number */</span></span><br><span class="line">   __u32 vfwmark;    <span class="comment">/* firewall mark of service */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="调度器ip-vs-scheduler"><a href="#调度器ip-vs-scheduler" class="headerlink" title="调度器ip_vs_scheduler:"></a>调度器<code>ip_vs_scheduler</code>:</h5><p>调度器由结构体<code>ip_vs_scheduler</code>描述，该结构体类似于一个基类，对于不同的调度算法，会挂接不同的<code>schedule</code>函数。在新建连接时，调用函数指针<code>schedule</code>选择合适的后端服务器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_scheduler</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">n_list</span>;</span>	<span class="comment">/* d-linked list head */</span></span><br><span class="line">	<span class="keyword">char</span> *name;		<span class="comment">/* scheduler name */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> refcnt;	<span class="comment">/* reference counter */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">module</span>;</span>	<span class="comment">/* THIS_MODULE/NULL */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* scheduler initializing service */</span></span><br><span class="line">	<span class="keyword">int</span> (*init_service) (struct ip_vs_service * svc);</span><br><span class="line">	<span class="comment">/* scheduling service finish */</span></span><br><span class="line">	<span class="keyword">int</span> (*done_service) (struct ip_vs_service * svc);</span><br><span class="line">	<span class="comment">/* scheduler updating service */</span></span><br><span class="line">	<span class="keyword">int</span> (*update_service) (struct ip_vs_service * svc);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* selecting a server from the given service */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_dest</span> *(*<span class="title">schedule</span>) (<span class="title">struct</span> <span class="title">ip_vs_service</span> * <span class="title">svc</span>,</span></span><br><span class="line"><span class="class">					<span class="title">const</span> <span class="title">struct</span> <span class="title">sk_buff</span> * <span class="title">skb</span>);</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
            <a href="/tags/LVS/" rel="tag"># LVS</a>
          
            <a href="/tags/load-balance/" rel="tag"># load balance</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018-1-24-flask-web/" rel="next" title="flask框架的使用">
                <i class="fa fa-chevron-left"></i> flask框架的使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018-09-09-consistent-hashing/" rel="prev" title="一致性哈希">
                一致性哈希 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lankstra</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://lankstra.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://lansheng.me/2018-09-08-lvsandlbalgo/';
          this.page.identifier = '2018-09-08-lvsandlbalgo/';
          this.page.title = 'LVS及负载均衡';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://lankstra.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
